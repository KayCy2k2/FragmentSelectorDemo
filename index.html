<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>FragmentSelector Demo</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js"></script>
<script>
/* ================== CLASS FRAGMENT SELECTOR ================== */
class FragmentSelector {
  constructor(scene, camera, world, domElement = window, CANNON) {
    this.scene = scene;
    this.camera = camera;
    this.world = world;
    this.domElement = domElement;
    this.CANNON = CANNON;

    this.fragments = [];
    this.selectedFragments = [];

    this.raycaster = new THREE.Raycaster();
    this.mouse = new THREE.Vector2();
    this._originalMaterials = new WeakMap();

    this.selectionColor = 0xffaa00;
    this.originalMesh = null;

    this._bindClick();
  }

  setFragments(fragments) {
    this.fragments = fragments || [];
  }

  _bindClick() {
    const handleSelect = (clientX, clientY, shiftKey = false) => {
      if (!this.fragments || this.fragments.length === 0) return;
      this.mouse.x = (clientX / window.innerWidth) * 2 - 1;
      this.mouse.y = -(clientY / window.innerHeight) * 2 + 1;
      this.raycaster.setFromCamera(this.mouse, this.camera);
  
      const meshes = this.fragments.map((f) => f.mesh);
      const intersects = this.raycaster.intersectObjects(meshes, false);
  
      if (intersects.length === 0) {
        if (!shiftKey) this.clearSelection();
        return;
      }
  
      const pickedMesh = intersects[0].object;
      const frag = this.fragments.find((f) => f.mesh === pickedMesh);
      if (!frag) return;
  
      if (!shiftKey) this.clearSelection();
  
      if (this.selectedFragments.includes(frag)) {
        this._deselectFragment(frag);
      } else {
        this._selectFragment(frag);
      }
    };
  
    // Click chuột
    this.domElement.addEventListener("click", (event) => {
      handleSelect(event.clientX, event.clientY, event.shiftKey);
    });
  
    // Cảm ứng
    this.domElement.addEventListener("touchstart", (event) => {
      if (event.touches.length > 0) {
        const touch = event.touches[0];
        handleSelect(touch.clientX, touch.clientY, event.shiftKey);
      }
    });
  }
  

  _selectFragment(frag) {
    if (!frag || !frag.mesh) return;

    // Đảm bảo không tạo glow chồng lên nếu đã có
    if (frag._glowEdge) return;

    // Tạo đối tượng phát sáng viền (EdgesGeometry)
    const edges = new THREE.EdgesGeometry(frag.mesh.geometry);
    const lineMat = new THREE.LineBasicMaterial({
      color: this.selectionColor,
      transparent: true,
      opacity: 1.0,
    });
    const line = new THREE.LineSegments(edges, lineMat);
    frag.mesh.add(line);
    frag._glowEdge = line;

    // Thêm vào danh sách chọn
    this.selectedFragments.push(frag);

    // Tạo hiệu ứng nhấp nháy viền
    let t = 0;
    const animateGlow = () => {
      if (!frag._glowEdge) return;
      t += 0.1;
      const opacity = 0.4 + 0.4 * Math.sin(t * 4);
      line.material.opacity = opacity;
      requestAnimationFrame(animateGlow);
    };
    animateGlow();
  }

  _deselectFragment(frag) {
    if (!frag || !frag.mesh) return;

    // Xóa viền phát sáng nếu có
    if (frag._glowEdge) {
      frag.mesh.remove(frag._glowEdge);
      frag._glowEdge.geometry.dispose();
      frag._glowEdge.material.dispose();
      frag._glowEdge = null;
    }

    const idx = this.selectedFragments.indexOf(frag);
    if (idx !== -1) this.selectedFragments.splice(idx, 1);
  }

  clearSelection() {
    while (this.selectedFragments.length > 0) {
      const f = this.selectedFragments.pop();
      if (f && f._glowEdge) {
        f.mesh.remove(f._glowEdge);
        f._glowEdge.geometry.dispose();
        f._glowEdge.material.dispose();
        f._glowEdge = null;
      }
    }
  }

  getSelectedFragments() {
    return this.selectedFragments.slice();
  }

  applyImpulseToSelected(baseStrength = 3) {
    if (!this.selectedFragments || this.selectedFragments.length === 0) return;
  
    this.selectedFragments.forEach((f) => {
      if (!f.body) return;
  
      f.body.type = this.CANNON.Body.DYNAMIC;
      f.body.mass = 1;
      f.body.updateMassProperties();
  
      // Hướng ngẫu nhiên (nhẹ)
      const dir = new this.CANNON.Vec3(
        Math.random() - 0.5,
        Math.random() * 0.5, // luôn hướng lên một chút
        Math.random() - 0.5
      ).normalize();
  
      // Biên độ ngẫu nhiên nhỏ (từ 0.5x đến 1.2x)
      const randomScale = 0.5 + Math.random() * 0.7;
  
      // Giảm cường độ tổng thể
      const strength = baseStrength * randomScale * 5;
  
      const impulse = dir.scale(strength);
  
      f.body.applyImpulse(impulse, f.body.position);
    });
  }
  

  reset(createOriginalShapeCallback = null) {
    this.clearSelection();
    this._originalMaterials = new WeakMap();

    if (this.originalMesh) {
      this.scene.remove(this.originalMesh);
      this.originalMesh = null;
    }

    this.fragments.forEach((f) => {
      if (f.mesh) this.scene.remove(f.mesh);
      if (f.body && this.world) this.world.removeBody(f.body);
    });
    this.fragments = [];

    if (createOriginalShapeCallback) {
      this.originalMesh = createOriginalShapeCallback();
    }
  }
  explodeFragment(frag) {
    if (!frag || !frag.mesh || !frag.body) return;

    const mesh = frag.mesh;
    const body = frag.body;

    // Bay lên
    const targetY = body.position.y + 1.5;
    const start = performance.now();

    const animateUp = (time) => {
      const t = Math.min((time - start) / 800, 1);
      body.position.y = THREE.MathUtils.lerp(body.position.y, targetY, t);
      mesh.scale.setScalar(1 + 0.5 * t); // phồng to dần

      if (t < 1) {
        requestAnimationFrame(animateUp);
      } else {
        this._explodeNow(frag);
      }
    };
    requestAnimationFrame(animateUp);
  }

  _explodeNow(frag) {
    // Hiệu ứng nổ (tạo các mảnh bay ra)
    const mesh = frag.mesh;
    const pos = mesh.position.clone();

    // Tạo mảnh nhỏ bay ra
    const pieces = [];
    for (let i = 0; i < 15; i++) {
      const geom = new THREE.SphereGeometry(0.03, 8, 8);
      const mat = new THREE.MeshStandardMaterial({
        color: 0xffaa00,
        emissive: 0xff4400,
      });
      const piece = new THREE.Mesh(geom, mat);
      piece.position.copy(pos);
      scene.add(piece);
      pieces.push(piece);

      // hiệu ứng bay
      const dir = new THREE.Vector3(
        Math.random() - 0.5,
        Math.random(),
        Math.random() - 0.5
      ).normalize();
      const speed = 0.05 + Math.random() * 0.05;

      let life = 0;
      const animatePiece = () => {
        life += 0.02;
        piece.position.addScaledVector(dir, speed);
        piece.material.opacity = 1 - life / 1.5;
        if (life < 1.5) {
          requestAnimationFrame(animatePiece);
        } else {
          scene.remove(piece);
        }
      };
      requestAnimationFrame(animatePiece);
    }

    // Ẩn khối gốc
    scene.remove(mesh);
    if (frag.body && world) world.removeBody(frag.body);

    // Hiển thị mini form
    createMiniForm(`<b>${frag.text}</b>`, frag.imgUrl);

  }

}
/* ============================================================= */
// 🔹 Mini UI helper
function createMiniForm(text, imageUrl = "img/moonlove.png") {
  let form = document.querySelector(".mini-form");
  if (!form) {
    form = document.createElement("div");
    form.className = "mini-form";
    document.body.appendChild(form);
  }

  Object.assign(form.style, {
    position: "fixed",
    top: "50%",
    left: "50%",
    transform: "translate(-50%, -50%) scale(1)",
    background: "rgba(255, 248, 220, 0.95)",
    color: "#4a2c2a",
    padding: "25px 30px",
    borderRadius: "18px",
    fontSize: "18px",
    fontFamily: "'Segoe UI', cursive",
    boxShadow: "0 0 25px rgba(255, 200, 150, 0.6)",
    zIndex: "9999",
    display: "flex",
    alignItems: "center",
    gap: "20px",
    maxWidth: "480px",
    transition: "all 0.4s ease",
  });

  form.innerHTML = `
    <button class="close-btn"
      style="
        position:absolute;
        top:8px;
        right:10px;
        background:transparent;
        border:none;
        color:#b33;
        font-size:22px;
        font-weight:bold;
        cursor:pointer;
        transition:0.2s;
      ">x</button>

    <img src="${imageUrl}" alt="Trung Thu"
      style="
        width:120px;height:120px;
        object-fit:cover;
        border-radius:50%;
        box-shadow:0 0 15px rgba(255,200,150,0.6);
        animation: glow 2s ease-in-out infinite alternate;
      " />

    <div style="flex:1;text-align:left;">
      <p style="margin:0;font-style:italic;">${text}</p>
    </div>
  `;

  const btn = form.querySelector(".close-btn");
  btn.onmouseenter = () => (btn.style.color = "#ff5555");
  btn.onmouseleave = () => (btn.style.color = "#b33");
  btn.onclick = () => form.remove();

  // Hiệu ứng phát sáng nhẹ cho ảnh
  const style = document.createElement("style");
  style.innerHTML = `
    @keyframes glow {
      from { box-shadow: 0 0 10px rgba(255,200,150,0.4); }
      to { box-shadow: 0 0 25px rgba(255,180,120,0.9); }
    }
  `;
  document.head.appendChild(style);

  return form;
}

/* ================== DEMO ================== */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(2, 2, 3);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

const world = new CANNON.World();
world.gravity.set(0,-9.82,0);

const groundBody = new CANNON.Body({ mass:0, shape: new CANNON.Plane() });
groundBody.quaternion.setFromEuler(-Math.PI/2,0,0);
groundBody.position.set(0, -1, 0); // 🔹 Hạ mặt đất thấp hơn 0.3
world.addBody(groundBody);


// ==== Thêm tường giới hạn (invisible walls) ====
const wallSize = 5;
const half = wallSize / 2;
const wallShape = new CANNON.Box(new CANNON.Vec3(half, half, 0.1));

// Tường trước
const wallFront = new CANNON.Body({ mass: 0 });
wallFront.addShape(wallShape);
wallFront.position.set(0, half, -2.5);
world.addBody(wallFront);

// Tường sau
const wallBack = new CANNON.Body({ mass: 0 });
wallBack.addShape(wallShape);
wallBack.position.set(0, half, 2.5);
world.addBody(wallBack);

// Tường trái
const wallLeft = new CANNON.Body({ mass: 0 });
wallLeft.addShape(new CANNON.Box(new CANNON.Vec3(0.1, half, half)));
wallLeft.position.set(-2.5, half, 0);
world.addBody(wallLeft);

// Tường phải
const wallRight = new CANNON.Body({ mass: 0 });
wallRight.addShape(new CANNON.Box(new CANNON.Vec3(0.1, half, half)));
wallRight.position.set(2.5, half, 0);
world.addBody(wallRight);
wallFront.material = new CANNON.Material("wallMat");
wallBack.material = wallFront.material;
wallLeft.material = wallFront.material;
wallRight.material = wallFront.material;

const contactMat = new CANNON.ContactMaterial(
  wallFront.material,
  new CANNON.Material("fragMat"),
  { restitution: 0.4 } // độ bật lại
);
world.addContactMaterial(contactMat);


function loadTextures(urls) {
  const loader = new THREE.TextureLoader();
  return Promise.all(urls.map(
    url => new Promise(resolve => {
      loader.load(url, tex => resolve(tex));
    })
  ));
}

// 🔹 Load 6 ảnh cho 6 mặt
const urls = [
  "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/u1.png", 
  "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/u2.png", 
  "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/u3.png", 
  "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/u4.png", 
  "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/u5.png", 
  "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/u6.png"
];

// Tạo khối lớn ban đầu
let originalMesh = null;
const splitButton = document.createElement("button");
splitButton.innerText = "Tách khối";
splitButton.style.position = "absolute";
splitButton.style.bottom = "30px";
splitButton.style.left = "50%";
splitButton.style.transform = "translateX(-50%)";
splitButton.style.padding = "10px 20px";
splitButton.style.border = "none";
splitButton.style.borderRadius = "10px";
splitButton.style.background = "#ffaa00";
splitButton.style.fontWeight = "bold";
splitButton.style.cursor = "pointer";
document.body.appendChild(splitButton);

// Load texture & khởi tạo khối lớn ban đầu
loadTextures(urls).then(faceTextures => {
  const materials = faceTextures.map(tex => new THREE.MeshStandardMaterial({ map: tex }));
  const geom = new THREE.BoxGeometry(1, 1, 1);
  originalMesh = new THREE.Mesh(geom, materials);
  originalMesh.position.y = 1; // nâng lên mặt đất
  scene.add(originalMesh);
});

// Khi nhấn nút “Tách khối”
splitButton.onclick = () => {
  if (!originalMesh) return;
  const start = performance.now();
  const duration = 1200;
  const crackPieces = [];
  const lightningBolts = [];

  // 🟠 Tạo các "mảnh nứt" nhỏ
  for (let i = 0; i < 25; i++) {
    const geom = new THREE.BoxGeometry(0.05, 0.05, 0.05);
    const mat = new THREE.MeshStandardMaterial({
      color: 0xffaa00,
      emissive: 0x552200,
      transparent: true,
      opacity: 1.0
    });
    const piece = new THREE.Mesh(geom, mat);
    piece.position.copy(originalMesh.position);
    scene.add(piece);
    crackPieces.push(piece);
  }

  // ⚡ Tạo tia điện ban đầu
  function createLightning() {
    const mat = new THREE.LineBasicMaterial({
      color: 0x00ffff,
      transparent: true,
      opacity: 0.8
    });

    const geom = new THREE.BufferGeometry();
    const points = [];
    const start = new THREE.Vector3(
      originalMesh.position.x + (Math.random() - 0.5),
      originalMesh.position.y + (Math.random() - 0.5),
      originalMesh.position.z + (Math.random() - 0.5)
    );
    const end = start.clone().add(new THREE.Vector3(
      (Math.random() - 0.5) * 1.2,
      (Math.random() - 0.5) * 1.2,
      (Math.random() - 0.5) * 1.2
    ));

    const segments = 5;
    for (let i = 0; i <= segments; i++) {
      const t = i / segments;
      const pos = new THREE.Vector3().lerpVectors(start, end, t);
      pos.x += (Math.random() - 0.5) * 0.05;
      pos.y += (Math.random() - 0.5) * 0.05;
      pos.z += (Math.random() - 0.5) * 0.05;
      points.push(pos);
    }

    geom.setFromPoints(points);
    const bolt = new THREE.Line(geom, mat);
    scene.add(bolt);
    lightningBolts.push(bolt);

    // Tự xóa sau một thời gian ngắn
    setTimeout(() => {
      scene.remove(bolt);
      geom.dispose();
      mat.dispose();
    }, 150 + Math.random() * 150);
  }

  // 🔹 Hiệu ứng nứt + rung + sét
  function crackEffect(time) {
    const t = Math.min((time - start) / duration, 1);
    const scale = 1 + 0.1 * Math.sin(t * Math.PI * 3);
    const jitter = 0.01 * Math.sin(t * 40);

    // Rung nhẹ khối lớn
    if (originalMesh) {
      originalMesh.scale.set(scale, scale, scale);
      originalMesh.position.x += (Math.random() - 0.5) * jitter;
      originalMesh.position.y += (Math.random() - 0.5) * jitter;
      originalMesh.position.z += (Math.random() - 0.5) * jitter;
    }

    // Cho mảnh nhỏ bay ra
    crackPieces.forEach(p => {
      const dir = new THREE.Vector3(Math.random() - 0.5, Math.random(), Math.random() - 0.5).normalize();
      p.position.addScaledVector(dir, 0.01);
      p.material.opacity = 1 - t;
    });

    // ⚡ Random tạo tia sét
    //if (Math.random() < 0.1) createLightning();

    if (t < 1) {
      requestAnimationFrame(crackEffect);
    } else {
      // Kết thúc hiệu ứng
      scene.remove(originalMesh);
      originalMesh.geometry.dispose();
      originalMesh.material.forEach(m => m.dispose());
      originalMesh = null;

      crackPieces.forEach(p => {
        scene.remove(p);
        p.geometry.dispose();
        p.material.dispose();
      });

      // Tạo các mảnh thật sự
      loadTextures(urls).then(faceTextures => {
        const fragments = generateFragments(faceTextures);
        selector.setFragments(fragments);
      });

      splitButton.style.display = "none";
    }
  }

  requestAnimationFrame(crackEffect);
};


// 🔸 Khối gốc (để tham chiếu)
function createOriginalShape() {
  const geom = new THREE.BoxGeometry(1,1,1);
  const mat = new THREE.MeshStandardMaterial({color:0x3399ff, wireframe:true});
  const mesh = new THREE.Mesh(geom, mat);
  scene.add(mesh);
  return mesh;
}

function generateFragments(faceTextures, n = 2) {
  const frags = [];
  const size = 1 / n;

  // 🔹 Map text ↔ ảnh
  // 🌕 Map thông điệp Trung Thu ↔ hình ảnh (phiên bản lãng mạn 💖)
  const imageMap = {
    "🌕 Trăng rằm sáng nhất là đêm nay... và em là người anh thương nhất.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/moonlove.png",
    "🍰 Bánh trung thu ngọt, nhưng vẫn chẳng ngọt bằng nụ cười của em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/mooncake.png",
    "🕯️ Dưới ánh đèn lồng, ta nắm tay nhau, cùng đi qua mùa trăng này.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/lanterns.png",
    "🐰 Chị Hằng có chú Cuội, còn anh chỉ có em — người anh thương.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/rabbitlove.png",
    "🌸 Dẫu bao mùa trăng đi qua, lòng anh vẫn hướng về một vầng trăng – là em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/lovers_moon.png",
    "💞 Trăng tròn rồi lại khuyết, nhưng tình mình sẽ chẳng bao giờ vơi.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/moon_couple.png",
    "🎑 Trung Thu này, ta cùng nhau ước nguyện, cho mai sau mãi chẳng rời xa.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/wish.png",
    "🕊️ Ánh trăng dịu, gió thu hiền, lòng anh chỉ muốn bên em mãi thôi.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/love_moonlight.png",
  
    // --- Thêm 56 thông điệp nữa ---
    "🌟 Dưới ánh trăng, mỗi khoảnh khắc bên em đều là phép màu.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/star_moon.png",
    "🌙 Em là vầng trăng giữa đêm tối, dẫn lối anh về hạnh phúc.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/moon_path.png",
    "🎆 Pháo hoa lung linh như trái tim anh đang bùng cháy vì em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/fireworks.png",
    "🍂 Gió thu nhè nhẹ, anh muốn ôm em thật chặt trong mùa trăng này.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/autumn_wind.png",
    "💌 Mỗi lời nhắn anh gửi đều là nụ hôn ngọt ngào gửi đến em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/love_letter.png",
    "🕯️ Ánh nến lung linh, anh chỉ muốn nhìn em cười mãi.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/candlelight.png",
    "🐇 Cuối cùng, chỉ cần em cười, cả thế giới anh đều tràn đầy ánh sáng.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/bunny_love2.png",
    "🌺 Hoa nở giữa mùa trăng, như tình yêu chúng ta ngày càng rực rỡ.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/flower_moon.png",
    "🌌 Bầu trời đầy sao, nhưng anh chỉ thấy em sáng nhất.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/star_sky.png",
    "🧧 Trung Thu này, ta cùng nhau chia sẻ những giây phút hạnh phúc.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/red_envelope.png",
    "🎐 Tiếng chuông gió vang lên, như lời nhắc về tình yêu chúng ta.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/wind_chime.png",
    "💖 Mùa trăng này, anh chỉ mong em cười, mọi thứ khác chẳng quan trọng.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/heart_moon.png",
    "🌕 Em là trăng tròn trong đêm, làm anh quên hết buồn phiền.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/full_moon.png",
    "🍡 Ăn bánh trung thu cùng em, ngọt hơn cả đường mật.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/mooncake_sweet.png",
    "🦋 Từng cánh bướm bay, anh đều mong được ôm em thật lâu.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/butterfly_love.png",
    "🎇 Ánh sáng pháo hoa rực rỡ, như trái tim anh khi nghĩ đến em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/fireworks2.png",
    "🕊️ Mỗi đêm trăng, anh gửi một lời yêu thương đến em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/dove_moon.png",
    "🌸 Hương hoa lan, hương mùa thu, nhưng ngọt ngào nhất vẫn là em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/flower_love.png",
    "💞 Tình yêu chúng ta, như ánh trăng tròn, không bao giờ vơi.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/moon_couple2.png",
    "🌌 Bầu trời đêm yên tĩnh, chỉ có anh và em dưới ánh trăng.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/night_sky.png",
    "🎑 Trung Thu hạnh phúc nhất, là khi ta nắm tay nhau đi dạo.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/love_walk.png",
    "🍂 Gió đưa lá bay, còn anh chỉ muốn đưa trái tim đến bên em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a1.png",
    "🕯️ Mọi ánh sáng lung linh đều nhường chỗ cho nụ cười của em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a2.png",
    "🐰 Em là Cuội trong trái tim anh, chẳng ai thay thế được.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a3.png",
    "🌺 Hoa cười, trăng sáng, anh cười khi nhìn thấy em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a4.png",
    "💌 Tin nhắn này, là anh gửi trọn tình yêu mùa Trung Thu.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a5.png",
    "🎆 Đêm trăng lung linh, anh và em, hai trái tim hòa nhịp.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a6.png",
    "🧧 Em cười, anh hạnh phúc, thế là đủ cho mùa Trung Thu.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a7.png",
    "🌟 Mỗi vì sao, mỗi ánh trăng đều nhắc anh nhớ em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a8.png",
    "🌙 Không gì đẹp hơn ánh trăng và nụ cười của em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a9.png",
    "🎐 Chuông gió reo, trái tim anh rung theo từng nhịp của em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a110.png",
    "💖 Mùa Trung Thu này, anh chỉ muốn ôm em thật chặt.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a11.png",
    "🕊️ Mỗi cánh chim bay, anh đều ước được bên em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a12.png",
    "🌸 Em là hương hoa, anh là gió, ta hòa vào nhau.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a13.png",
    "💞 Trung Thu này, anh hứa yêu em mãi không rời.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a14.png",
    "🌌 Mọi vì sao đều tỏa sáng, nhưng sáng nhất là em trong mắt anh.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a15.png",
    "🎑 Ánh trăng chiếu rọi, dẫn lối hai ta về bên nhau.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a16.png",
    "🍂 Lá vàng rơi, tình yêu chúng ta vẫn đong đầy.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a17.png",
    "🕯️ Nến lung linh, lòng anh cũng lung linh vì em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a18.png",
    "🐰 Trăng có Cuội, anh có em, mãi không rời.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a19.png",
    "🌺 Hoa nở, lòng anh cũng nở theo nụ cười em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a20.png",
    "💌 Tin nhắn đêm Trung Thu, trao em trọn trái tim.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a21.png",
    "🎆 Pháo hoa rực rỡ, tình yêu chúng ta rực rỡ hơn.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a22.png",
    "🧧 Bao lì xì cũng không ngọt bằng em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a23.png",
    "🌟 Sao trời lấp lánh, nhưng anh chỉ thấy em thôi.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a24.png",
    "🌙 Trăng thu tròn, tình yêu ta trọn vẹn.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a25.png",
    "🎐 Chuông gió reo, như trái tim anh gọi tên em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a26.png",
    "💖 Em là ánh trăng, anh là gió, luôn bên nhau.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a27.png",
    "🕊️ Bay theo cánh chim, anh muốn gửi em lời yêu thương.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a28.png",
    "🌸 Hương hoa, ánh trăng, nụ cười em làm anh say đắm.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a29.png",
    "💞 Tình yêu này, như ánh trăng tròn, vẹn nguyên suốt đời.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a30.png",
    "🌌 Trăng, sao, gió, lá, tất cả đều nhắc về em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a31.png",
    "🎑 Đêm Trung Thu, tay trong tay, ta đi khắp thế gian.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a32.png",
    "🍂 Gió thu nhè nhẹ, anh muốn ôm em suốt mùa trăng.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a33.png",
    "🕯️ Nến rực sáng, anh cũng sáng vì em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a34.png",
    "🐰 Mùa Trung Thu này, em là Cuội, anh là vầng trăng luôn chiếu sáng.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a35.png",
    "🌺 Trái tim anh nở rộ như hoa giữa mùa trăng chỉ vì em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a36.png",
    "💌 Mỗi tin nhắn là một nụ hôn gửi đến em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a37.png",
    "🎆 Trung Thu rực rỡ, tình yêu ta rực rỡ hơn mọi pháo hoa.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a38.png",
    "🧧 Lì xì trao em, tình yêu trao cả đời.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a39.png"
  };
  
  // 🔹 Tạo mảng text có thể dùng (copy để không làm thay đổi bản gốc)
  const availableTexts = Object.keys(imageMap);

  for (let xi = 0; xi < n; xi++) {
    for (let yi = 0; yi < n; yi++) {
      for (let zi = 0; zi < n; zi++) {
        // Bỏ khối bên trong (chỉ giữ bề mặt)
        if (xi > 0 && xi < n - 1 && yi > 0 && yi < n - 1 && zi > 0 && zi < n - 1)
          continue;

        const geom = new THREE.BoxGeometry(size, size, size);
        const materials = faceTextures.map(tex => {
          const cloned = tex.clone();
          cloned.wrapS = cloned.wrapT = THREE.RepeatWrapping;
          cloned.needsUpdate = true;
          return new THREE.MeshStandardMaterial({ map: cloned });
        });

        const mesh = new THREE.Mesh(geom, materials);
        mesh.position.set(
          -0.5 + xi * size + size / 2,
          -0.5 + yi * size + size / 2 + 1,
          -0.5 + zi * size + size / 2
        );
        scene.add(mesh);

        const body = new CANNON.Body({
          mass: 1,
          shape: new CANNON.Box(new CANNON.Vec3(size / 2, size / 2, size / 2))
        });
        body.position.copy(mesh.position);
        world.addBody(body);

        // ✅ Gán text ngẫu nhiên không lặp
        let text = "💥 Khối trống";
        let imgUrl = "img/default.png";
        if (availableTexts.length > 0) {
          const index = Math.floor(Math.random() * availableTexts.length);
          text = availableTexts.splice(index, 1)[0]; // lấy và loại khỏi danh sách
          imgUrl = imageMap[text];
        }

        // ✅ Lưu cả ảnh vào object fragment
        frags.push({ mesh, body, xi, yi, zi, text, imgUrl });
      }
    }
  }

  // === Giữ phần UV offset của bạn (không đổi) ===
  const clamp01 = v => Math.max(0, Math.min(0.999999, v));
  const normals = [
    new THREE.Vector3(1, 0, 0),
    new THREE.Vector3(-1, 0, 0),
    new THREE.Vector3(0, 1, 0),
    new THREE.Vector3(0, -1, 0),
    new THREE.Vector3(0, 0, 1),
    new THREE.Vector3(0, 0, -1)
  ];

  frags.forEach(frag => {
    const mesh = frag.mesh;
    const P = new THREE.Vector3(mesh.position.x, mesh.position.y - 1, mesh.position.z);

    mesh.material.forEach((mat, faceIndex) => {
      if (!mat.map) return;
      const normal = normals[faceIndex].clone();
      let upRef = new THREE.Vector3(0, 1, 0);
      if (Math.abs(normal.dot(upRef)) > 0.999) upRef = new THREE.Vector3(0, 0, 1);

      const u = new THREE.Vector3().copy(upRef).cross(normal).normalize();
      const v = new THREE.Vector3().copy(normal).cross(u).normalize();

      const ucoord = clamp01(u.dot(P) + 0.5);
      const vcoord = clamp01(v.dot(P) + 0.5);

      let uIndex = Math.floor(ucoord * n);
      let vIndex = Math.floor(vcoord * n);

      if (faceIndex === 2) {
        vIndex = n - 1 - vIndex;
        uIndex = n - 1 - uIndex;
      }

      mat.map.repeat.set(1 / n, 1 / n);
      mat.map.offset.set(uIndex / n, vIndex / n);
      mat.map.needsUpdate = true;
    });
  });

  return frags;
}



// ánh sáng
const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(5,10,5);
scene.add(light);
scene.add(new THREE.AmbientLight(0xffffff,0.3));

// selector
const selector = new FragmentSelector(scene, camera, world, renderer.domElement, CANNON);
// Nút mở (ẩn ban đầu)
const openButton = document.createElement("button");
openButton.innerText = "Mở";
openButton.style.position = "absolute";
openButton.style.bottom = "30px";
openButton.style.left = "50%";
openButton.style.transform = "translateX(-50%)";
openButton.style.padding = "10px 20px";
openButton.style.border = "none";
openButton.style.borderRadius = "10px";
openButton.style.background = "#ffaa00";
openButton.style.fontWeight = "bold";
openButton.style.cursor = "pointer";
openButton.style.display = "none";
document.body.appendChild(openButton);

// Hiển thị nút khi chọn
const originalSelect = selector._selectFragment.bind(selector);
selector._selectFragment = function(frag) {
  originalSelect(frag);
  openButton.style.display = "block";
  openButton.onclick = () => {
    openButton.style.display = "none";
    this.explodeFragment(frag);
  };
};

// Ẩn khi bỏ chọn
const originalClear = selector.clearSelection.bind(selector);
selector.clearSelection = function() {
  openButton.style.display = "none";
  originalClear();
};

// test impulse
window.addEventListener("keydown", (e)=>{
  if (e.key === "i") selector.applyImpulseToSelected(10);
});

function animate() {
  requestAnimationFrame(animate);
  world.step(1/60);
  selector.fragments.forEach(f=>{
    if (f.mesh && f.body) {
      f.mesh.position.copy(f.body.position);
      f.mesh.quaternion.copy(f.body.quaternion);
    }
  });
  controls.update();
  renderer.render(scene, camera);
}
animate();

</script>
</body>
</html>
