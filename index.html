<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>FragmentSelector Demo</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js"></script>
<script>
/* ================== CLASS FRAGMENT SELECTOR ================== */
class FragmentSelector {
  constructor(scene, camera, world, domElement = window, CANNON) {
    this.scene = scene;
    this.camera = camera;
    this.world = world;
    this.domElement = domElement;
    this.CANNON = CANNON;

    this.fragments = [];
    this.selectedFragments = [];

    this.raycaster = new THREE.Raycaster();
    this.mouse = new THREE.Vector2();
    this._originalMaterials = new WeakMap();

    this.selectionColor = 0xffaa00;
    this.originalMesh = null;

    this._bindClick();
  }

  setFragments(fragments) {
    this.fragments = fragments || [];
  }

  _bindClick() {
    const handleSelect = (clientX, clientY, shiftKey = false) => {
      if (!this.fragments || this.fragments.length === 0) return;
      this.mouse.x = (clientX / window.innerWidth) * 2 - 1;
      this.mouse.y = -(clientY / window.innerHeight) * 2 + 1;
      this.raycaster.setFromCamera(this.mouse, this.camera);
  
      const meshes = this.fragments.map((f) => f.mesh);
      const intersects = this.raycaster.intersectObjects(meshes, false);
  
      if (intersects.length === 0) {
        if (!shiftKey) this.clearSelection();
        return;
      }
  
      const pickedMesh = intersects[0].object;
      const frag = this.fragments.find((f) => f.mesh === pickedMesh);
      if (!frag) return;
  
      if (!shiftKey) this.clearSelection();
  
      if (this.selectedFragments.includes(frag)) {
        this._deselectFragment(frag);
      } else {
        this._selectFragment(frag);
      }
    };
  
    // Click chuá»™t
    this.domElement.addEventListener("click", (event) => {
      handleSelect(event.clientX, event.clientY, event.shiftKey);
    });
  
    // Cáº£m á»©ng
    this.domElement.addEventListener("touchstart", (event) => {
      if (event.touches.length > 0) {
        const touch = event.touches[0];
        handleSelect(touch.clientX, touch.clientY, event.shiftKey);
      }
    });
  }
  

  _selectFragment(frag) {
    if (!frag || !frag.mesh) return;

    // Äáº£m báº£o khÃ´ng táº¡o glow chá»“ng lÃªn náº¿u Ä‘Ã£ cÃ³
    if (frag._glowEdge) return;

    // Táº¡o Ä‘á»‘i tÆ°á»£ng phÃ¡t sÃ¡ng viá»n (EdgesGeometry)
    const edges = new THREE.EdgesGeometry(frag.mesh.geometry);
    const lineMat = new THREE.LineBasicMaterial({
      color: this.selectionColor,
      transparent: true,
      opacity: 1.0,
    });
    const line = new THREE.LineSegments(edges, lineMat);
    frag.mesh.add(line);
    frag._glowEdge = line;

    // ThÃªm vÃ o danh sÃ¡ch chá»n
    this.selectedFragments.push(frag);

    // Táº¡o hiá»‡u á»©ng nháº¥p nhÃ¡y viá»n
    let t = 0;
    const animateGlow = () => {
      if (!frag._glowEdge) return;
      t += 0.1;
      const opacity = 0.4 + 0.4 * Math.sin(t * 4);
      line.material.opacity = opacity;
      requestAnimationFrame(animateGlow);
    };
    animateGlow();
  }

  _deselectFragment(frag) {
    if (!frag || !frag.mesh) return;

    // XÃ³a viá»n phÃ¡t sÃ¡ng náº¿u cÃ³
    if (frag._glowEdge) {
      frag.mesh.remove(frag._glowEdge);
      frag._glowEdge.geometry.dispose();
      frag._glowEdge.material.dispose();
      frag._glowEdge = null;
    }

    const idx = this.selectedFragments.indexOf(frag);
    if (idx !== -1) this.selectedFragments.splice(idx, 1);
  }

  clearSelection() {
    while (this.selectedFragments.length > 0) {
      const f = this.selectedFragments.pop();
      if (f && f._glowEdge) {
        f.mesh.remove(f._glowEdge);
        f._glowEdge.geometry.dispose();
        f._glowEdge.material.dispose();
        f._glowEdge = null;
      }
    }
  }

  getSelectedFragments() {
    return this.selectedFragments.slice();
  }

  applyImpulseToSelected(baseStrength = 3) {
    if (!this.selectedFragments || this.selectedFragments.length === 0) return;
  
    this.selectedFragments.forEach((f) => {
      if (!f.body) return;
  
      f.body.type = this.CANNON.Body.DYNAMIC;
      f.body.mass = 1;
      f.body.updateMassProperties();
  
      // HÆ°á»›ng ngáº«u nhiÃªn (nháº¹)
      const dir = new this.CANNON.Vec3(
        Math.random() - 0.5,
        Math.random() * 0.5, // luÃ´n hÆ°á»›ng lÃªn má»™t chÃºt
        Math.random() - 0.5
      ).normalize();
  
      // BiÃªn Ä‘á»™ ngáº«u nhiÃªn nhá» (tá»« 0.5x Ä‘áº¿n 1.2x)
      const randomScale = 0.5 + Math.random() * 0.7;
  
      // Giáº£m cÆ°á»ng Ä‘á»™ tá»•ng thá»ƒ
      const strength = baseStrength * randomScale * 5;
  
      const impulse = dir.scale(strength);
  
      f.body.applyImpulse(impulse, f.body.position);
    });
  }
  

  reset(createOriginalShapeCallback = null) {
    this.clearSelection();
    this._originalMaterials = new WeakMap();

    if (this.originalMesh) {
      this.scene.remove(this.originalMesh);
      this.originalMesh = null;
    }

    this.fragments.forEach((f) => {
      if (f.mesh) this.scene.remove(f.mesh);
      if (f.body && this.world) this.world.removeBody(f.body);
    });
    this.fragments = [];

    if (createOriginalShapeCallback) {
      this.originalMesh = createOriginalShapeCallback();
    }
  }
  explodeFragment(frag) {
    if (!frag || !frag.mesh || !frag.body) return;

    const mesh = frag.mesh;
    const body = frag.body;

    // Bay lÃªn
    const targetY = body.position.y + 1.5;
    const start = performance.now();

    const animateUp = (time) => {
      const t = Math.min((time - start) / 800, 1);
      body.position.y = THREE.MathUtils.lerp(body.position.y, targetY, t);
      mesh.scale.setScalar(1 + 0.5 * t); // phá»“ng to dáº§n

      if (t < 1) {
        requestAnimationFrame(animateUp);
      } else {
        this._explodeNow(frag);
      }
    };
    requestAnimationFrame(animateUp);
  }

  _explodeNow(frag) {
    // Hiá»‡u á»©ng ná»• (táº¡o cÃ¡c máº£nh bay ra)
    const mesh = frag.mesh;
    const pos = mesh.position.clone();

    // Táº¡o máº£nh nhá» bay ra
    const pieces = [];
    for (let i = 0; i < 15; i++) {
      const geom = new THREE.SphereGeometry(0.03, 8, 8);
      const mat = new THREE.MeshStandardMaterial({
        color: 0xffaa00,
        emissive: 0xff4400,
      });
      const piece = new THREE.Mesh(geom, mat);
      piece.position.copy(pos);
      scene.add(piece);
      pieces.push(piece);

      // hiá»‡u á»©ng bay
      const dir = new THREE.Vector3(
        Math.random() - 0.5,
        Math.random(),
        Math.random() - 0.5
      ).normalize();
      const speed = 0.05 + Math.random() * 0.05;

      let life = 0;
      const animatePiece = () => {
        life += 0.02;
        piece.position.addScaledVector(dir, speed);
        piece.material.opacity = 1 - life / 1.5;
        if (life < 1.5) {
          requestAnimationFrame(animatePiece);
        } else {
          scene.remove(piece);
        }
      };
      requestAnimationFrame(animatePiece);
    }

    // áº¨n khá»‘i gá»‘c
    scene.remove(mesh);
    if (frag.body && world) world.removeBody(frag.body);

    // Hiá»ƒn thá»‹ mini form
    createMiniForm(`<b>${frag.text}</b>`, frag.imgUrl);

  }

}
/* ============================================================= */
// ğŸ”¹ Mini UI helper
function createMiniForm(text, imageUrl = "img/moonlove.png") {
  let form = document.querySelector(".mini-form");
  if (!form) {
    form = document.createElement("div");
    form.className = "mini-form";
    document.body.appendChild(form);
  }

  Object.assign(form.style, {
    position: "fixed",
    top: "50%",
    left: "50%",
    transform: "translate(-50%, -50%) scale(1)",
    background: "rgba(255, 248, 220, 0.95)",
    color: "#4a2c2a",
    padding: "25px 30px",
    borderRadius: "18px",
    fontSize: "18px",
    fontFamily: "'Segoe UI', cursive",
    boxShadow: "0 0 25px rgba(255, 200, 150, 0.6)",
    zIndex: "9999",
    display: "flex",
    alignItems: "center",
    gap: "20px",
    maxWidth: "480px",
    transition: "all 0.4s ease",
  });

  form.innerHTML = `
    <button class="close-btn"
      style="
        position:absolute;
        top:8px;
        right:10px;
        background:transparent;
        border:none;
        color:#b33;
        font-size:22px;
        font-weight:bold;
        cursor:pointer;
        transition:0.2s;
      ">x</button>

    <img src="${imageUrl}" alt="Trung Thu"
      style="
        width:120px;height:120px;
        object-fit:cover;
        border-radius:50%;
        box-shadow:0 0 15px rgba(255,200,150,0.6);
        animation: glow 2s ease-in-out infinite alternate;
      " />

    <div style="flex:1;text-align:left;">
      <p style="margin:0;font-style:italic;">${text}</p>
    </div>
  `;

  const btn = form.querySelector(".close-btn");
  btn.onmouseenter = () => (btn.style.color = "#ff5555");
  btn.onmouseleave = () => (btn.style.color = "#b33");
  btn.onclick = () => form.remove();

  // Hiá»‡u á»©ng phÃ¡t sÃ¡ng nháº¹ cho áº£nh
  const style = document.createElement("style");
  style.innerHTML = `
    @keyframes glow {
      from { box-shadow: 0 0 10px rgba(255,200,150,0.4); }
      to { box-shadow: 0 0 25px rgba(255,180,120,0.9); }
    }
  `;
  document.head.appendChild(style);

  return form;
}

/* ================== DEMO ================== */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(2, 2, 3);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

const world = new CANNON.World();
world.gravity.set(0,-9.82,0);

const groundBody = new CANNON.Body({ mass:0, shape: new CANNON.Plane() });
groundBody.quaternion.setFromEuler(-Math.PI/2,0,0);
groundBody.position.set(0, -1, 0); // ğŸ”¹ Háº¡ máº·t Ä‘áº¥t tháº¥p hÆ¡n 0.3
world.addBody(groundBody);


// ==== ThÃªm tÆ°á»ng giá»›i háº¡n (invisible walls) ====
const wallSize = 5;
const half = wallSize / 2;
const wallShape = new CANNON.Box(new CANNON.Vec3(half, half, 0.1));

// TÆ°á»ng trÆ°á»›c
const wallFront = new CANNON.Body({ mass: 0 });
wallFront.addShape(wallShape);
wallFront.position.set(0, half, -2.5);
world.addBody(wallFront);

// TÆ°á»ng sau
const wallBack = new CANNON.Body({ mass: 0 });
wallBack.addShape(wallShape);
wallBack.position.set(0, half, 2.5);
world.addBody(wallBack);

// TÆ°á»ng trÃ¡i
const wallLeft = new CANNON.Body({ mass: 0 });
wallLeft.addShape(new CANNON.Box(new CANNON.Vec3(0.1, half, half)));
wallLeft.position.set(-2.5, half, 0);
world.addBody(wallLeft);

// TÆ°á»ng pháº£i
const wallRight = new CANNON.Body({ mass: 0 });
wallRight.addShape(new CANNON.Box(new CANNON.Vec3(0.1, half, half)));
wallRight.position.set(2.5, half, 0);
world.addBody(wallRight);
wallFront.material = new CANNON.Material("wallMat");
wallBack.material = wallFront.material;
wallLeft.material = wallFront.material;
wallRight.material = wallFront.material;

const contactMat = new CANNON.ContactMaterial(
  wallFront.material,
  new CANNON.Material("fragMat"),
  { restitution: 0.4 } // Ä‘á»™ báº­t láº¡i
);
world.addContactMaterial(contactMat);


function loadTextures(urls) {
  const loader = new THREE.TextureLoader();
  return Promise.all(urls.map(
    url => new Promise(resolve => {
      loader.load(url, tex => resolve(tex));
    })
  ));
}

// ğŸ”¹ Load 6 áº£nh cho 6 máº·t
const urls = [
  "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/u1.png", 
  "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/u2.png", 
  "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/u3.png", 
  "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/u4.png", 
  "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/u5.png", 
  "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/u6.png"
];

// Táº¡o khá»‘i lá»›n ban Ä‘áº§u
let originalMesh = null;
const splitButton = document.createElement("button");
splitButton.innerText = "TÃ¡ch khá»‘i";
splitButton.style.position = "absolute";
splitButton.style.bottom = "30px";
splitButton.style.left = "50%";
splitButton.style.transform = "translateX(-50%)";
splitButton.style.padding = "10px 20px";
splitButton.style.border = "none";
splitButton.style.borderRadius = "10px";
splitButton.style.background = "#ffaa00";
splitButton.style.fontWeight = "bold";
splitButton.style.cursor = "pointer";
document.body.appendChild(splitButton);

// Load texture & khá»Ÿi táº¡o khá»‘i lá»›n ban Ä‘áº§u
loadTextures(urls).then(faceTextures => {
  const materials = faceTextures.map(tex => new THREE.MeshStandardMaterial({ map: tex }));
  const geom = new THREE.BoxGeometry(1, 1, 1);
  originalMesh = new THREE.Mesh(geom, materials);
  originalMesh.position.y = 1; // nÃ¢ng lÃªn máº·t Ä‘áº¥t
  scene.add(originalMesh);
});

// Khi nháº¥n nÃºt â€œTÃ¡ch khá»‘iâ€
splitButton.onclick = () => {
  if (!originalMesh) return;
  const start = performance.now();
  const duration = 1200;
  const crackPieces = [];
  const lightningBolts = [];

  // ğŸŸ  Táº¡o cÃ¡c "máº£nh ná»©t" nhá»
  for (let i = 0; i < 25; i++) {
    const geom = new THREE.BoxGeometry(0.05, 0.05, 0.05);
    const mat = new THREE.MeshStandardMaterial({
      color: 0xffaa00,
      emissive: 0x552200,
      transparent: true,
      opacity: 1.0
    });
    const piece = new THREE.Mesh(geom, mat);
    piece.position.copy(originalMesh.position);
    scene.add(piece);
    crackPieces.push(piece);
  }

  // âš¡ Táº¡o tia Ä‘iá»‡n ban Ä‘áº§u
  function createLightning() {
    const mat = new THREE.LineBasicMaterial({
      color: 0x00ffff,
      transparent: true,
      opacity: 0.8
    });

    const geom = new THREE.BufferGeometry();
    const points = [];
    const start = new THREE.Vector3(
      originalMesh.position.x + (Math.random() - 0.5),
      originalMesh.position.y + (Math.random() - 0.5),
      originalMesh.position.z + (Math.random() - 0.5)
    );
    const end = start.clone().add(new THREE.Vector3(
      (Math.random() - 0.5) * 1.2,
      (Math.random() - 0.5) * 1.2,
      (Math.random() - 0.5) * 1.2
    ));

    const segments = 5;
    for (let i = 0; i <= segments; i++) {
      const t = i / segments;
      const pos = new THREE.Vector3().lerpVectors(start, end, t);
      pos.x += (Math.random() - 0.5) * 0.05;
      pos.y += (Math.random() - 0.5) * 0.05;
      pos.z += (Math.random() - 0.5) * 0.05;
      points.push(pos);
    }

    geom.setFromPoints(points);
    const bolt = new THREE.Line(geom, mat);
    scene.add(bolt);
    lightningBolts.push(bolt);

    // Tá»± xÃ³a sau má»™t thá»i gian ngáº¯n
    setTimeout(() => {
      scene.remove(bolt);
      geom.dispose();
      mat.dispose();
    }, 150 + Math.random() * 150);
  }

  // ğŸ”¹ Hiá»‡u á»©ng ná»©t + rung + sÃ©t
  function crackEffect(time) {
    const t = Math.min((time - start) / duration, 1);
    const scale = 1 + 0.1 * Math.sin(t * Math.PI * 3);
    const jitter = 0.01 * Math.sin(t * 40);

    // Rung nháº¹ khá»‘i lá»›n
    if (originalMesh) {
      originalMesh.scale.set(scale, scale, scale);
      originalMesh.position.x += (Math.random() - 0.5) * jitter;
      originalMesh.position.y += (Math.random() - 0.5) * jitter;
      originalMesh.position.z += (Math.random() - 0.5) * jitter;
    }

    // Cho máº£nh nhá» bay ra
    crackPieces.forEach(p => {
      const dir = new THREE.Vector3(Math.random() - 0.5, Math.random(), Math.random() - 0.5).normalize();
      p.position.addScaledVector(dir, 0.01);
      p.material.opacity = 1 - t;
    });

    // âš¡ Random táº¡o tia sÃ©t
    //if (Math.random() < 0.1) createLightning();

    if (t < 1) {
      requestAnimationFrame(crackEffect);
    } else {
      // Káº¿t thÃºc hiá»‡u á»©ng
      scene.remove(originalMesh);
      originalMesh.geometry.dispose();
      originalMesh.material.forEach(m => m.dispose());
      originalMesh = null;

      crackPieces.forEach(p => {
        scene.remove(p);
        p.geometry.dispose();
        p.material.dispose();
      });

      // Táº¡o cÃ¡c máº£nh tháº­t sá»±
      loadTextures(urls).then(faceTextures => {
        const fragments = generateFragments(faceTextures);
        selector.setFragments(fragments);
      });

      splitButton.style.display = "none";
    }
  }

  requestAnimationFrame(crackEffect);
};


// ğŸ”¸ Khá»‘i gá»‘c (Ä‘á»ƒ tham chiáº¿u)
function createOriginalShape() {
  const geom = new THREE.BoxGeometry(1,1,1);
  const mat = new THREE.MeshStandardMaterial({color:0x3399ff, wireframe:true});
  const mesh = new THREE.Mesh(geom, mat);
  scene.add(mesh);
  return mesh;
}

function generateFragments(faceTextures, n = 2) {
  const frags = [];
  const size = 1 / n;

  // ğŸ”¹ Map text â†” áº£nh
  // ğŸŒ• Map thÃ´ng Ä‘iá»‡p Trung Thu â†” hÃ¬nh áº£nh (phiÃªn báº£n lÃ£ng máº¡n ğŸ’–)
  const imageMap = {
    "ğŸŒ• TrÄƒng ráº±m sÃ¡ng nháº¥t lÃ  Ä‘Ãªm nay... vÃ  em lÃ  ngÆ°á»i anh thÆ°Æ¡ng nháº¥t.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/moonlove.png",
    "ğŸ° BÃ¡nh trung thu ngá»t, nhÆ°ng váº«n cháº³ng ngá»t báº±ng ná»¥ cÆ°á»i cá»§a em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/mooncake.png",
    "ğŸ•¯ï¸ DÆ°á»›i Ã¡nh Ä‘Ã¨n lá»“ng, ta náº¯m tay nhau, cÃ¹ng Ä‘i qua mÃ¹a trÄƒng nÃ y.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/lanterns.png",
    "ğŸ° Chá»‹ Háº±ng cÃ³ chÃº Cuá»™i, cÃ²n anh chá»‰ cÃ³ em â€” ngÆ°á»i anh thÆ°Æ¡ng.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/rabbitlove.png",
    "ğŸŒ¸ Dáº«u bao mÃ¹a trÄƒng Ä‘i qua, lÃ²ng anh váº«n hÆ°á»›ng vá» má»™t váº§ng trÄƒng â€“ lÃ  em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/lovers_moon.png",
    "ğŸ’ TrÄƒng trÃ²n rá»“i láº¡i khuyáº¿t, nhÆ°ng tÃ¬nh mÃ¬nh sáº½ cháº³ng bao giá» vÆ¡i.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/moon_couple.png",
    "ğŸ‘ Trung Thu nÃ y, ta cÃ¹ng nhau Æ°á»›c nguyá»‡n, cho mai sau mÃ£i cháº³ng rá»i xa.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/wish.png",
    "ğŸ•Šï¸ Ãnh trÄƒng dá»‹u, giÃ³ thu hiá»n, lÃ²ng anh chá»‰ muá»‘n bÃªn em mÃ£i thÃ´i.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/love_moonlight.png",
  
    // --- ThÃªm 56 thÃ´ng Ä‘iá»‡p ná»¯a ---
    "ğŸŒŸ DÆ°á»›i Ã¡nh trÄƒng, má»—i khoáº£nh kháº¯c bÃªn em Ä‘á»u lÃ  phÃ©p mÃ u.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/star_moon.png",
    "ğŸŒ™ Em lÃ  váº§ng trÄƒng giá»¯a Ä‘Ãªm tá»‘i, dáº«n lá»‘i anh vá» háº¡nh phÃºc.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/moon_path.png",
    "ğŸ† PhÃ¡o hoa lung linh nhÆ° trÃ¡i tim anh Ä‘ang bÃ¹ng chÃ¡y vÃ¬ em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/fireworks.png",
    "ğŸ‚ GiÃ³ thu nhÃ¨ nháº¹, anh muá»‘n Ã´m em tháº­t cháº·t trong mÃ¹a trÄƒng nÃ y.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/autumn_wind.png",
    "ğŸ’Œ Má»—i lá»i nháº¯n anh gá»­i Ä‘á»u lÃ  ná»¥ hÃ´n ngá»t ngÃ o gá»­i Ä‘áº¿n em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/love_letter.png",
    "ğŸ•¯ï¸ Ãnh náº¿n lung linh, anh chá»‰ muá»‘n nhÃ¬n em cÆ°á»i mÃ£i.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/candlelight.png",
    "ğŸ‡ Cuá»‘i cÃ¹ng, chá»‰ cáº§n em cÆ°á»i, cáº£ tháº¿ giá»›i anh Ä‘á»u trÃ n Ä‘áº§y Ã¡nh sÃ¡ng.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/bunny_love2.png",
    "ğŸŒº Hoa ná»Ÿ giá»¯a mÃ¹a trÄƒng, nhÆ° tÃ¬nh yÃªu chÃºng ta ngÃ y cÃ ng rá»±c rá»¡.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/flower_moon.png",
    "ğŸŒŒ Báº§u trá»i Ä‘áº§y sao, nhÆ°ng anh chá»‰ tháº¥y em sÃ¡ng nháº¥t.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/star_sky.png",
    "ğŸ§§ Trung Thu nÃ y, ta cÃ¹ng nhau chia sáº» nhá»¯ng giÃ¢y phÃºt háº¡nh phÃºc.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/red_envelope.png",
    "ğŸ Tiáº¿ng chuÃ´ng giÃ³ vang lÃªn, nhÆ° lá»i nháº¯c vá» tÃ¬nh yÃªu chÃºng ta.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/wind_chime.png",
    "ğŸ’– MÃ¹a trÄƒng nÃ y, anh chá»‰ mong em cÆ°á»i, má»i thá»© khÃ¡c cháº³ng quan trá»ng.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/heart_moon.png",
    "ğŸŒ• Em lÃ  trÄƒng trÃ²n trong Ä‘Ãªm, lÃ m anh quÃªn háº¿t buá»“n phiá»n.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/full_moon.png",
    "ğŸ¡ Ä‚n bÃ¡nh trung thu cÃ¹ng em, ngá»t hÆ¡n cáº£ Ä‘Æ°á»ng máº­t.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/mooncake_sweet.png",
    "ğŸ¦‹ Tá»«ng cÃ¡nh bÆ°á»›m bay, anh Ä‘á»u mong Ä‘Æ°á»£c Ã´m em tháº­t lÃ¢u.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/butterfly_love.png",
    "ğŸ‡ Ãnh sÃ¡ng phÃ¡o hoa rá»±c rá»¡, nhÆ° trÃ¡i tim anh khi nghÄ© Ä‘áº¿n em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/fireworks2.png",
    "ğŸ•Šï¸ Má»—i Ä‘Ãªm trÄƒng, anh gá»­i má»™t lá»i yÃªu thÆ°Æ¡ng Ä‘áº¿n em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/dove_moon.png",
    "ğŸŒ¸ HÆ°Æ¡ng hoa lan, hÆ°Æ¡ng mÃ¹a thu, nhÆ°ng ngá»t ngÃ o nháº¥t váº«n lÃ  em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/flower_love.png",
    "ğŸ’ TÃ¬nh yÃªu chÃºng ta, nhÆ° Ã¡nh trÄƒng trÃ²n, khÃ´ng bao giá» vÆ¡i.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/moon_couple2.png",
    "ğŸŒŒ Báº§u trá»i Ä‘Ãªm yÃªn tÄ©nh, chá»‰ cÃ³ anh vÃ  em dÆ°á»›i Ã¡nh trÄƒng.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/night_sky.png",
    "ğŸ‘ Trung Thu háº¡nh phÃºc nháº¥t, lÃ  khi ta náº¯m tay nhau Ä‘i dáº¡o.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/love_walk.png",
    "ğŸ‚ GiÃ³ Ä‘Æ°a lÃ¡ bay, cÃ²n anh chá»‰ muá»‘n Ä‘Æ°a trÃ¡i tim Ä‘áº¿n bÃªn em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a1.png",
    "ğŸ•¯ï¸ Má»i Ã¡nh sÃ¡ng lung linh Ä‘á»u nhÆ°á»ng chá»— cho ná»¥ cÆ°á»i cá»§a em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a2.png",
    "ğŸ° Em lÃ  Cuá»™i trong trÃ¡i tim anh, cháº³ng ai thay tháº¿ Ä‘Æ°á»£c.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a3.png",
    "ğŸŒº Hoa cÆ°á»i, trÄƒng sÃ¡ng, anh cÆ°á»i khi nhÃ¬n tháº¥y em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a4.png",
    "ğŸ’Œ Tin nháº¯n nÃ y, lÃ  anh gá»­i trá»n tÃ¬nh yÃªu mÃ¹a Trung Thu.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a5.png",
    "ğŸ† ÄÃªm trÄƒng lung linh, anh vÃ  em, hai trÃ¡i tim hÃ²a nhá»‹p.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a6.png",
    "ğŸ§§ Em cÆ°á»i, anh háº¡nh phÃºc, tháº¿ lÃ  Ä‘á»§ cho mÃ¹a Trung Thu.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a7.png",
    "ğŸŒŸ Má»—i vÃ¬ sao, má»—i Ã¡nh trÄƒng Ä‘á»u nháº¯c anh nhá»› em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a8.png",
    "ğŸŒ™ KhÃ´ng gÃ¬ Ä‘áº¹p hÆ¡n Ã¡nh trÄƒng vÃ  ná»¥ cÆ°á»i cá»§a em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a9.png",
    "ğŸ ChuÃ´ng giÃ³ reo, trÃ¡i tim anh rung theo tá»«ng nhá»‹p cá»§a em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a110.png",
    "ğŸ’– MÃ¹a Trung Thu nÃ y, anh chá»‰ muá»‘n Ã´m em tháº­t cháº·t.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a11.png",
    "ğŸ•Šï¸ Má»—i cÃ¡nh chim bay, anh Ä‘á»u Æ°á»›c Ä‘Æ°á»£c bÃªn em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a12.png",
    "ğŸŒ¸ Em lÃ  hÆ°Æ¡ng hoa, anh lÃ  giÃ³, ta hÃ²a vÃ o nhau.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a13.png",
    "ğŸ’ Trung Thu nÃ y, anh há»©a yÃªu em mÃ£i khÃ´ng rá»i.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a14.png",
    "ğŸŒŒ Má»i vÃ¬ sao Ä‘á»u tá»a sÃ¡ng, nhÆ°ng sÃ¡ng nháº¥t lÃ  em trong máº¯t anh.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a15.png",
    "ğŸ‘ Ãnh trÄƒng chiáº¿u rá»i, dáº«n lá»‘i hai ta vá» bÃªn nhau.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a16.png",
    "ğŸ‚ LÃ¡ vÃ ng rÆ¡i, tÃ¬nh yÃªu chÃºng ta váº«n Ä‘ong Ä‘áº§y.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a17.png",
    "ğŸ•¯ï¸ Náº¿n lung linh, lÃ²ng anh cÅ©ng lung linh vÃ¬ em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a18.png",
    "ğŸ° TrÄƒng cÃ³ Cuá»™i, anh cÃ³ em, mÃ£i khÃ´ng rá»i.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a19.png",
    "ğŸŒº Hoa ná»Ÿ, lÃ²ng anh cÅ©ng ná»Ÿ theo ná»¥ cÆ°á»i em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a20.png",
    "ğŸ’Œ Tin nháº¯n Ä‘Ãªm Trung Thu, trao em trá»n trÃ¡i tim.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a21.png",
    "ğŸ† PhÃ¡o hoa rá»±c rá»¡, tÃ¬nh yÃªu chÃºng ta rá»±c rá»¡ hÆ¡n.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a22.png",
    "ğŸ§§ Bao lÃ¬ xÃ¬ cÅ©ng khÃ´ng ngá»t báº±ng em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a23.png",
    "ğŸŒŸ Sao trá»i láº¥p lÃ¡nh, nhÆ°ng anh chá»‰ tháº¥y em thÃ´i.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a24.png",
    "ğŸŒ™ TrÄƒng thu trÃ²n, tÃ¬nh yÃªu ta trá»n váº¹n.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a25.png",
    "ğŸ ChuÃ´ng giÃ³ reo, nhÆ° trÃ¡i tim anh gá»i tÃªn em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a26.png",
    "ğŸ’– Em lÃ  Ã¡nh trÄƒng, anh lÃ  giÃ³, luÃ´n bÃªn nhau.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a27.png",
    "ğŸ•Šï¸ Bay theo cÃ¡nh chim, anh muá»‘n gá»­i em lá»i yÃªu thÆ°Æ¡ng.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a28.png",
    "ğŸŒ¸ HÆ°Æ¡ng hoa, Ã¡nh trÄƒng, ná»¥ cÆ°á»i em lÃ m anh say Ä‘áº¯m.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a29.png",
    "ğŸ’ TÃ¬nh yÃªu nÃ y, nhÆ° Ã¡nh trÄƒng trÃ²n, váº¹n nguyÃªn suá»‘t Ä‘á»i.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a30.png",
    "ğŸŒŒ TrÄƒng, sao, giÃ³, lÃ¡, táº¥t cáº£ Ä‘á»u nháº¯c vá» em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a31.png",
    "ğŸ‘ ÄÃªm Trung Thu, tay trong tay, ta Ä‘i kháº¯p tháº¿ gian.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a32.png",
    "ğŸ‚ GiÃ³ thu nhÃ¨ nháº¹, anh muá»‘n Ã´m em suá»‘t mÃ¹a trÄƒng.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a33.png",
    "ğŸ•¯ï¸ Náº¿n rá»±c sÃ¡ng, anh cÅ©ng sÃ¡ng vÃ¬ em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a34.png",
    "ğŸ° MÃ¹a Trung Thu nÃ y, em lÃ  Cuá»™i, anh lÃ  váº§ng trÄƒng luÃ´n chiáº¿u sÃ¡ng.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a35.png",
    "ğŸŒº TrÃ¡i tim anh ná»Ÿ rá»™ nhÆ° hoa giá»¯a mÃ¹a trÄƒng chá»‰ vÃ¬ em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a36.png",
    "ğŸ’Œ Má»—i tin nháº¯n lÃ  má»™t ná»¥ hÃ´n gá»­i Ä‘áº¿n em.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a37.png",
    "ğŸ† Trung Thu rá»±c rá»¡, tÃ¬nh yÃªu ta rá»±c rá»¡ hÆ¡n má»i phÃ¡o hoa.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a38.png",
    "ğŸ§§ LÃ¬ xÃ¬ trao em, tÃ¬nh yÃªu trao cáº£ Ä‘á»i.": "https://raw.githubusercontent.com/KayCy2k2/FragmentSelectorDemo/refs/heads/main/img/a39.png"
  };
  
  // ğŸ”¹ Táº¡o máº£ng text cÃ³ thá»ƒ dÃ¹ng (copy Ä‘á»ƒ khÃ´ng lÃ m thay Ä‘á»•i báº£n gá»‘c)
  const availableTexts = Object.keys(imageMap);

  for (let xi = 0; xi < n; xi++) {
    for (let yi = 0; yi < n; yi++) {
      for (let zi = 0; zi < n; zi++) {
        // Bá» khá»‘i bÃªn trong (chá»‰ giá»¯ bá» máº·t)
        if (xi > 0 && xi < n - 1 && yi > 0 && yi < n - 1 && zi > 0 && zi < n - 1)
          continue;

        const geom = new THREE.BoxGeometry(size, size, size);
        const materials = faceTextures.map(tex => {
          const cloned = tex.clone();
          cloned.wrapS = cloned.wrapT = THREE.RepeatWrapping;
          cloned.needsUpdate = true;
          return new THREE.MeshStandardMaterial({ map: cloned });
        });

        const mesh = new THREE.Mesh(geom, materials);
        mesh.position.set(
          -0.5 + xi * size + size / 2,
          -0.5 + yi * size + size / 2 + 1,
          -0.5 + zi * size + size / 2
        );
        scene.add(mesh);

        const body = new CANNON.Body({
          mass: 1,
          shape: new CANNON.Box(new CANNON.Vec3(size / 2, size / 2, size / 2))
        });
        body.position.copy(mesh.position);
        world.addBody(body);

        // âœ… GÃ¡n text ngáº«u nhiÃªn khÃ´ng láº·p
        let text = "ğŸ’¥ Khá»‘i trá»‘ng";
        let imgUrl = "img/default.png";
        if (availableTexts.length > 0) {
          const index = Math.floor(Math.random() * availableTexts.length);
          text = availableTexts.splice(index, 1)[0]; // láº¥y vÃ  loáº¡i khá»i danh sÃ¡ch
          imgUrl = imageMap[text];
        }

        // âœ… LÆ°u cáº£ áº£nh vÃ o object fragment
        frags.push({ mesh, body, xi, yi, zi, text, imgUrl });
      }
    }
  }

  // === Giá»¯ pháº§n UV offset cá»§a báº¡n (khÃ´ng Ä‘á»•i) ===
  const clamp01 = v => Math.max(0, Math.min(0.999999, v));
  const normals = [
    new THREE.Vector3(1, 0, 0),
    new THREE.Vector3(-1, 0, 0),
    new THREE.Vector3(0, 1, 0),
    new THREE.Vector3(0, -1, 0),
    new THREE.Vector3(0, 0, 1),
    new THREE.Vector3(0, 0, -1)
  ];

  frags.forEach(frag => {
    const mesh = frag.mesh;
    const P = new THREE.Vector3(mesh.position.x, mesh.position.y - 1, mesh.position.z);

    mesh.material.forEach((mat, faceIndex) => {
      if (!mat.map) return;
      const normal = normals[faceIndex].clone();
      let upRef = new THREE.Vector3(0, 1, 0);
      if (Math.abs(normal.dot(upRef)) > 0.999) upRef = new THREE.Vector3(0, 0, 1);

      const u = new THREE.Vector3().copy(upRef).cross(normal).normalize();
      const v = new THREE.Vector3().copy(normal).cross(u).normalize();

      const ucoord = clamp01(u.dot(P) + 0.5);
      const vcoord = clamp01(v.dot(P) + 0.5);

      let uIndex = Math.floor(ucoord * n);
      let vIndex = Math.floor(vcoord * n);

      if (faceIndex === 2) {
        vIndex = n - 1 - vIndex;
        uIndex = n - 1 - uIndex;
      }

      mat.map.repeat.set(1 / n, 1 / n);
      mat.map.offset.set(uIndex / n, vIndex / n);
      mat.map.needsUpdate = true;
    });
  });

  return frags;
}



// Ã¡nh sÃ¡ng
const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(5,10,5);
scene.add(light);
scene.add(new THREE.AmbientLight(0xffffff,0.3));

// selector
const selector = new FragmentSelector(scene, camera, world, renderer.domElement, CANNON);
// NÃºt má»Ÿ (áº©n ban Ä‘áº§u)
const openButton = document.createElement("button");
openButton.innerText = "Má»Ÿ";
openButton.style.position = "absolute";
openButton.style.bottom = "30px";
openButton.style.left = "50%";
openButton.style.transform = "translateX(-50%)";
openButton.style.padding = "10px 20px";
openButton.style.border = "none";
openButton.style.borderRadius = "10px";
openButton.style.background = "#ffaa00";
openButton.style.fontWeight = "bold";
openButton.style.cursor = "pointer";
openButton.style.display = "none";
document.body.appendChild(openButton);

// Hiá»ƒn thá»‹ nÃºt khi chá»n
const originalSelect = selector._selectFragment.bind(selector);
selector._selectFragment = function(frag) {
  originalSelect(frag);
  openButton.style.display = "block";
  openButton.onclick = () => {
    openButton.style.display = "none";
    this.explodeFragment(frag);
  };
};

// áº¨n khi bá» chá»n
const originalClear = selector.clearSelection.bind(selector);
selector.clearSelection = function() {
  openButton.style.display = "none";
  originalClear();
};

// test impulse
window.addEventListener("keydown", (e)=>{
  if (e.key === "i") selector.applyImpulseToSelected(10);
});

function animate() {
  requestAnimationFrame(animate);
  world.step(1/60);
  selector.fragments.forEach(f=>{
    if (f.mesh && f.body) {
      f.mesh.position.copy(f.body.position);
      f.mesh.quaternion.copy(f.body.quaternion);
    }
  });
  controls.update();
  renderer.render(scene, camera);
}
animate();

</script>
</body>
</html>
